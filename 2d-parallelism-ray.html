<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- HTML Meta Tags -->
  <title>Malaysia-AI blog 2D Parallelism using Ray PyTorch</title>
  <meta name="description" content="Malaysia-AI blog 2D Parallelism using Ray PyTorch">

  <!-- Facebook Meta Tags -->
  <meta property="og:url" content="https://malaysia-ai.org/2d-parallelism-ray">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Malaysia-AI blog 2D Parallelism using Ray PyTorch">
  <meta property="og:description" content="Malaysia-AI blog 2D Parallelism using Ray PyTorch">
  <meta property="og:image" content="https://malaysia-ai.org/2d-parallelism-ray.png">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="twitter:domain" content="malaysia-ai.org">
  <meta property="twitter:url" content="https://malaysia-ai.org/2d-parallelism-ray">
  <meta name="twitter:title" content="Malaysia-AI blog 2D Parallelism using Ray PyTorch">
  <meta name="twitter:description" content="Malaysia-AI blog 2D Parallelism using Ray PyTorch">
  <meta name="twitter:image" content="https://malaysia-ai.org/2d-parallelism-ray.png">

  <!-- Meta Tags Generated via https://www.opengraph.xyz -->

  <style>
    body {
      line-height: 1.4;
      font-size: 16px;
      padding: 0 10px;
      margin: 50px auto;
      max-width: 1000px;
    }

    #maincontent {
      max-width: 62em;
      margin: 15 auto;
    }

    pre {
      margin-top: 0px;
      white-space: break-spaces;
    }
  </style>
</head>

<body>

  <div id="maincontent" style="margin-top: 70px">
    <h2>2D Parallelism using Ray PyTorch</h2>
    <p>Last time we already covered <a href="/tp-pytorch">Tensor Parallelism</a> and little bit of Pipeline Parallelism
      using PyTorch Distributed Elastic, but did you know that you can combine Tensor Parallelism and Pipeline
      Parallelism in the same parallelism? Actually we got up to 4D! Tensor Parallelism + Pipeline Parallelism + Data
      Parallelism + Context Parallelism, TP + PP + DP + CP! But this blog we will only cover TP and PP.</p>
    <p>As we know, Tensor Parallelism split the weights either Row-Wise or Column-Wise to N GPUs and Pipeline
      Parallelism split hidden layers to N GPUs,</p>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 300">
      <!-- Tensor Parallelism -->
      <g transform="translate(0, 0)">
        <text x="200" y="30" font-size="16" font-weight="bold">Tensor Parallelism (2 GPUs)</text>

        <!-- Input -->
        <rect x="50" y="50" width="60" height="40" fill="#ADD8E6" stroke="black" />
        <text x="80" y="75" font-size="12" text-anchor="middle">Input</text>
        <text x="80" y="85" font-size="10" text-anchor="middle">1x4</text>

        <!-- First Linear Layer -->
        <rect x="150" y="50" width="120" height="40" fill="#90EE90" stroke="black" />
        <text x="210" y="75" font-size="12" text-anchor="middle">Linear 4x4</text>
        <line x1="210" y1="50" x2="210" y2="90" stroke="black" stroke-dasharray="5,5" />
        <text x="175" y="105" font-size="10" text-anchor="end">GPU 0</text>
        <text x="245" y="105" font-size="10" text-anchor="start">GPU 1</text>

        <!-- Second Linear Layer -->
        <rect x="310" y="50" width="120" height="40" fill="#FFA07A" stroke="black" />
        <text x="370" y="75" font-size="12" text-anchor="middle">Linear 4x2</text>
        <line x1="370" y1="50" x2="370" y2="90" stroke="black" stroke-dasharray="5,5" />
        <text x="335" y="105" font-size="10" text-anchor="end">GPU 0</text>
        <text x="405" y="105" font-size="10" text-anchor="start">GPU 1</text>

        <!-- Output -->
        <rect x="470" y="50" width="60" height="40" fill="#FFD700" stroke="black" />
        <text x="500" y="75" font-size="12" text-anchor="middle">Output</text>
        <text x="500" y="85" font-size="10" text-anchor="middle">1x2</text>

        <!-- Connections -->
        <line x1="110" y1="70" x2="150" y2="70" stroke="black" marker-end="url(#arrowhead)" />
        <line x1="270" y1="70" x2="310" y2="70" stroke="black" marker-end="url(#arrowhead)" />
        <line x1="430" y1="70" x2="470" y2="70" stroke="black" marker-end="url(#arrowhead)" />
      </g>

      <!-- Pipeline Parallelism -->
      <g transform="translate(0, 150)">
        <text x="200" y="30" font-size="16" font-weight="bold">Pipeline Parallelism (2 GPUs)</text>

        <!-- GPU 0 -->
        <rect x="50" y="50" width="240" height="80" fill="#E6E6FA" stroke="black" />
        <text x="170" y="70" font-size="14" text-anchor="middle">GPU 0</text>

        <!-- Input -->
        <rect x="70" y="80" width="60" height="40" fill="#ADD8E6" stroke="black" />
        <text x="100" y="105" font-size="12" text-anchor="middle">Input</text>
        <text x="100" y="115" font-size="10" text-anchor="middle">1x4</text>

        <!-- First Linear Layer -->
        <rect x="160" y="80" width="110" height="40" fill="#90EE90" stroke="black" />
        <text x="215" y="105" font-size="12" text-anchor="middle">Linear 4x4</text>

        <!-- GPU 1 -->
        <rect x="330" y="50" width="240" height="80" fill="#FFE4E1" stroke="black" />
        <text x="450" y="70" font-size="14" text-anchor="middle">GPU 1</text>

        <!-- Second Linear Layer -->
        <rect x="350" y="80" width="110" height="40" fill="#FFA07A" stroke="black" />
        <text x="405" y="105" font-size="12" text-anchor="middle">Linear 4x2</text>

        <!-- Output -->
        <rect x="490" y="80" width="60" height="40" fill="#FFD700" stroke="black" />
        <text x="520" y="105" font-size="12" text-anchor="middle">Output</text>
        <text x="520" y="115" font-size="10" text-anchor="middle">1x2</text>

        <!-- Connections -->
        <line x1="130" y1="100" x2="160" y2="100" stroke="black" marker-end="url(#arrowhead)" />
        <line x1="270" y1="100" x2="350" y2="100" stroke="black" marker-end="url(#arrowhead)" />
        <line x1="460" y1="100" x2="490" y2="100" stroke="black" marker-end="url(#arrowhead)" />
      </g>

      <!-- Arrowhead definition -->
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" />
        </marker>
      </defs>
    </svg>
    <p>We can combine TP and PP to become a single parallelism, called 2D Parallelism. Assumed I have a deep learning
      model
      with 4 hidden layers, and each hidden layer got a linear layer, to make the model fit into 2D Parallelism,</p>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 450">
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#000" />
        </marker>
      </defs>

      <!-- GPU Rectangles -->
      <rect x="50" y="50" width="700" height="80" fill="#e6f3ff" stroke="#000" stroke-width="2" />
      <rect x="50" y="150" width="700" height="80" fill="#e6f3ff" stroke="#000" stroke-width="2" />
      <rect x="50" y="250" width="700" height="80" fill="#e6f3ff" stroke="#000" stroke-width="2" />
      <rect x="50" y="350" width="700" height="80" fill="#e6f3ff" stroke="#000" stroke-width="2" />

      <!-- GPU Labels -->
      <text x="60" y="90" font-family="Arial" font-size="20">GPU 0</text>
      <text x="60" y="190" font-family="Arial" font-size="20">GPU 1</text>
      <text x="60" y="290" font-family="Arial" font-size="20">GPU 2</text>
      <text x="60" y="390" font-family="Arial" font-size="20">GPU 3</text>

      <!-- Hidden Layers -->
      <rect x="150" y="60" width="80" height="60" fill="#ffcccc" stroke="#000" />
      <rect x="250" y="60" width="80" height="60" fill="#ffddcc" stroke="#000" />
      <rect x="150" y="160" width="80" height="60" fill="#ffcccc" stroke="#000" />
      <rect x="250" y="160" width="80" height="60" fill="#ffddcc" stroke="#000" />

      <rect x="350" y="260" width="80" height="60" fill="#ffeedd" stroke="#000" />
      <rect x="450" y="260" width="80" height="60" fill="#ffeecc" stroke="#000" />
      <rect x="350" y="360" width="80" height="60" fill="#ffeedd" stroke="#000" />
      <rect x="450" y="360" width="80" height="60" fill="#ffeecc" stroke="#000" />



      <!-- Layer Labels -->
      <text x="170" y="95" font-family="Arial" font-size="12">HL 0</text>
      <text x="270" y="95" font-family="Arial" font-size="12">HL 1</text>
      <text x="170" y="195" font-family="Arial" font-size="12">HL 0</text>
      <text x="270" y="195" font-family="Arial" font-size="12">HL 1</text>

      <text x="370" y="295" font-family="Arial" font-size="12">HL 2</text>
      <text x="470" y="295" font-family="Arial" font-size="12">HL 3</text>
      <text x="370" y="395" font-family="Arial" font-size="12">HL 2</text>
      <text x="470" y="395" font-family="Arial" font-size="12">HL 3</text>

      <!-- Tensor Parallelism Arrows -->
      <line x1="190" y1="120" x2="190" y2="160" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />
      <line x1="290" y1="120" x2="290" y2="160" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />
      <line x1="390" y1="320" x2="390" y2="360" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />
      <line x1="490" y1="320" x2="490" y2="360" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />

      <!-- Pipeline Parallelism Arrows -->
      <line x1="330" y1="120" x2="350" y2="260" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />

      <!-- Legend -->
      <rect x="50" y="10" width="20" height="20" fill="#ffcccc" stroke="#000" />
      <text x="75" y="25" font-family="Arial" font-size="12">HL 0</text>
      <rect x="150" y="10" width="20" height="20" fill="#ffddcc" stroke="#000" />
      <text x="175" y="25" font-family="Arial" font-size="12">HL 1</text>
      <rect x="250" y="10" width="20" height="20" fill="#ffeedd" stroke="#000" />
      <text x="275" y="25" font-family="Arial" font-size="12">HL 2</text>
      <rect x="350" y="10" width="20" height="20" fill="#ffeecc" stroke="#000" />
      <text x="375" y="25" font-family="Arial" font-size="12">HL 3</text>
    </svg>
    <p>- GPU 0 take hidden layers 0-1, this is a PP for hidden layers 0-1, and GPU 0 TP with GPU 1 to shard the weights,
      this can be done using `torch.distributed.new_group`. This required 2 GPUs.</p>
    <p>- Output from hidden layers 0-1 in GPU 0 and will pass to GPU 2, and GPU 2 PP hidden layers 2-3. GPU 2 TP with
      GPU 3 to shard the weights. Also required to create new group using `torch.distributed.new_group`. This required 2
      GPUs.</p>
    <p>- The number of GPUs required is, M PP x N TP, if M = 2 and N = 2, we need 4 GPUs. 1 PP 2 TP means, all
      hidden
      layers inside the same GPU 0, but the weights sharded with GPU 1, so it required 2 GPUs.</p>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 450">
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#000" />
        </marker>
      </defs>

      <!-- GPU Rectangles -->
      <rect x="50" y="50" width="700" height="80" fill="#e6f3ff" stroke="#000" stroke-width="2" />
      <rect x="50" y="150" width="700" height="80" fill="#e6f3ff" stroke="#000" stroke-width="2" />
      <rect x="50" y="250" width="700" height="80" fill="#e6f3ff" stroke="#000" stroke-width="2" />
      <rect x="50" y="350" width="700" height="80" fill="#e6f3ff" stroke="#000" stroke-width="2" />

      <!-- GPU Labels -->
      <text x="60" y="90" font-family="Arial" font-size="20">GPU 0</text>
      <text x="60" y="190" font-family="Arial" font-size="20">GPU 1</text>
      <text x="60" y="290" font-family="Arial" font-size="20">GPU 2</text>
      <text x="60" y="390" font-family="Arial" font-size="20">GPU 3</text>

      <!-- Hidden Layers -->
      <rect x="150" y="60" width="80" height="60" fill="#ffcccc" stroke="#000" />
      <rect x="250" y="60" width="80" height="60" fill="#ffddcc" stroke="#000" />
      <rect x="150" y="160" width="80" height="60" fill="#ffcccc" stroke="#000" />
      <rect x="250" y="160" width="80" height="60" fill="#ffddcc" stroke="#000" />

      <rect x="350" y="260" width="80" height="60" fill="#ffeedd" stroke="#000" />
      <rect x="450" y="260" width="80" height="60" fill="#ffeecc" stroke="#000" />
      <rect x="350" y="360" width="80" height="60" fill="#ffeedd" stroke="#000" />
      <rect x="450" y="360" width="80" height="60" fill="#ffeecc" stroke="#000" />

      <!-- Layer Labels -->
      <text x="170" y="95" font-family="Arial" font-size="12">HL 0</text>
      <text x="270" y="95" font-family="Arial" font-size="12">HL 1</text>
      <text x="170" y="195" font-family="Arial" font-size="12">HL 0</text>
      <text x="270" y="195" font-family="Arial" font-size="12">HL 1</text>

      <text x="370" y="295" font-family="Arial" font-size="12">HL 2</text>
      <text x="470" y="295" font-family="Arial" font-size="12">HL 3</text>
      <text x="370" y="395" font-family="Arial" font-size="12">HL 2</text>
      <text x="470" y="395" font-family="Arial" font-size="12">HL 3</text>

      <!-- Tensor Parallelism Arrows -->
      <line x1="190" y1="120" x2="190" y2="160" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />
      <line x1="290" y1="120" x2="290" y2="160" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />
      <line x1="390" y1="320" x2="390" y2="360" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />
      <line x1="490" y1="320" x2="490" y2="360" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />

      <!-- Pipeline Parallelism Arrows -->
      <line x1="330" y1="120" x2="350" y2="260" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)" />

      <!-- New Group Visualizations (Squares) -->
      <!-- TP Group for GPUs 0 and 1 -->
      <rect x="40" y="40" width="320" height="200" fill="none" stroke="#ff0000" stroke-width="2"
        stroke-dasharray="5,5" />
      <text x="70" y="65" font-family="Arial" font-size="14" fill="#ff0000">TP Group: [0, 1]</text>

      <!-- TP Group for GPUs 2 and 3 -->
      <rect x="40" y="240" width="520" height="200" fill="none" stroke="#00ff00" stroke-width="2"
        stroke-dasharray="5,5" />
      <text x="70" y="265" font-family="Arial" font-size="14" fill="#00ff00">TP Group: [2, 3]</text>

      <!-- PP Group for GPUs 0 and 2 -->
      <rect x="30" y="40" width="540" height="400" fill="none" stroke="#0000ff" stroke-width="2"
        stroke-dasharray="5,5" />
      <text x="580" y="65" font-family="Arial" font-size="14" fill="#0000ff">PP Group: [0, 2]</text>

      <!-- Legend -->
      <rect x="50" y="10" width="20" height="20" fill="#ffcccc" stroke="#000" />
      <text x="75" y="25" font-family="Arial" font-size="12">HL 0</text>
      <rect x="150" y="10" width="20" height="20" fill="#ffddcc" stroke="#000" />
      <text x="175" y="25" font-family="Arial" font-size="12">HL 1</text>
      <rect x="250" y="10" width="20" height="20" fill="#ffeedd" stroke="#000" />
      <text x="275" y="25" font-family="Arial" font-size="12">HL 2</text>
      <rect x="350" y="10" width="20" height="20" fill="#ffeecc" stroke="#000" />
      <text x="375" y="25" font-family="Arial" font-size="12">HL 3</text>
    </svg>
    <p>- TP Group: [0, 1] is the TP communication group for GPU 0 and GPU 1, PP Group: [0, 2] is the PP communication
      group for GPU 0 and GPU 2, and TP Group: [2, 3] is the TP communication group for GPU 2 and GPU 3.</p>


    <p>---</p>
    <p>thats all, give some love to <a href="https://x.com/aisyahhhrzk" target="_blank">Aisyah Razak.</a></p>
  </div>
</body>

</html>